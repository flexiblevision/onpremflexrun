# Testing Quick Reference

## Run Tests

```bash
./run_tests.sh                  # All tests
./run_tests.sh unit             # Unit tests only
./run_tests.sh integration      # Integration tests
./run_tests.sh quick            # Skip slow tests
./run_tests.sh coverage         # With coverage report
./run_tests.sh file <path>      # Specific file
./run_tests.sh clean            # Clean artifacts
```

## Pytest Commands

```bash
pytest                          # All tests
pytest -v                       # Verbose
pytest -vv                      # Very verbose
pytest -s                       # Show print statements
pytest --pdb                    # Debug on failure
pytest -k "test_name"           # Run tests matching name
pytest -m unit                  # Run tests with marker
pytest tests/unit/              # Run directory
pytest --lf                     # Run last failed
pytest --ff                     # Run failed first
```

## Markers

```python
@pytest.mark.unit               # Unit test
@pytest.mark.integration        # Integration test
@pytest.mark.slow               # Slow test
@pytest.mark.network            # Needs network
@pytest.mark.database           # Needs database
@pytest.mark.gpio               # GPIO test
```

## Common Fixtures

```python
def test_example(client,                # Flask test client
                mock_mongo_client,      # Mocked MongoDB
                mock_redis,             # Mocked Redis
                mock_job_queue,         # Mocked RQ queue
                auth_headers,           # Auth headers
                mock_subprocess,        # Mocked subprocess
                mock_os_system,         # Mocked os.system
                mock_requests):         # Mocked HTTP
    pass
```

## Mocking Examples

```python
# Mock subprocess
@patch('subprocess.Popen')
def test_subprocess(mock_popen):
    mock_proc = MagicMock()
    mock_proc.communicate.return_value = (b'output', b'')
    mock_popen.return_value = mock_proc

# Mock requests
@patch('requests.get')
def test_request(mock_get):
    mock_response = MagicMock()
    mock_response.status_code = 200
    mock_get.return_value = mock_response

# Mock file
@patch('builtins.open', mock_open(read_data='content'))
def test_file(mock_file):
    pass

# Bypass auth
@patch('auth.requires_auth', lambda f: f)
def test_endpoint():
    pass
```

## Test Structure

```python
class TestFeature:
    """Tests for feature"""

    @pytest.mark.unit
    def test_scenario(self):
        """Test description"""
        # Arrange
        data = "input"

        # Act
        result = function(data)

        # Assert
        assert result == "expected"
```

## Coverage

```bash
pytest --cov=routes --cov=utils --cov-report=html
open htmlcov/index.html
```

## Debugging

```bash
pytest -vv -s                   # Verbose + print
pytest --pdb                    # Debug on fail
pytest --trace                  # Debug from start
pytest --lf --pdb               # Debug last failure
```

## Files

- `conftest.py` - Fixtures
- `pytest.ini` - Configuration
- `test_requirements.txt` - Dependencies
- `run_tests.sh` - Test runner
- `tests/README.md` - Full docs
